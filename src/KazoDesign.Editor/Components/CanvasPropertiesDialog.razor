@using KazoDesign.Editor.Models
@using KazoDesign.Editor.Services
@inject DesignService DesignService

@if (IsVisible)
{
    <div class="dialog-overlay" @onclick="Close">
        <div class="dialog dialog-large" @onclick:stopPropagation="true">
            <div class="dialog-header">
                <h3>Canvas Properties</h3>
                <button class="dialog-close-btn" @onclick="Close" title="Close">
                    <svg viewBox="0 0 24 24" width="16" height="16">
                        <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2"/>
                    </svg>
                </button>
            </div>
            
            <div class="dialog-body">
                <div class="dialog-section">
                    <h4 class="dialog-section-title">Document Info</h4>
                    
                    <div class="dialog-field">
                        <label class="dialog-label">Title</label>
                        <input type="text" 
                               class="dialog-input" 
                               placeholder="Enter design title"
                               @bind="DocumentTitle"
                               @bind:event="oninput" />
                    </div>
                    
                    <div class="dialog-field">
                        <label class="dialog-label">Description</label>
                        <textarea class="dialog-input dialog-textarea" 
                                  placeholder="Describe your design (purpose, contents, notes...)"
                                  rows="3"
                                  @bind="DocumentDescription"
                                  @bind:event="oninput"></textarea>
                    </div>
                </div>

                <div class="dialog-section">
                    <h4 class="dialog-section-title">Canvas Size</h4>
                    
                    <div class="dialog-row">
                        <div class="dialog-field dialog-field-half">
                            <label class="dialog-label">Width (px)</label>
                            <input type="number" min="100" max="4000" step="10"
                                   class="dialog-input" 
                                   @bind="CanvasWidth"
                                   @bind:event="oninput" />
                        </div>
                        <div class="dialog-field dialog-field-half">
                            <label class="dialog-label">Height (px)</label>
                            <input type="number" min="100" max="4000" step="10"
                                   class="dialog-input" 
                                   @bind="CanvasHeight"
                                   @bind:event="oninput" />
                        </div>
                    </div>
                    
                    <div class="dialog-field">
                        <label class="dialog-label">Preset Sizes</label>
                        <div class="preset-buttons">
                            <button class="preset-btn" @onclick='() => SetPresetSize(800, 600)'>800×600</button>
                            <button class="preset-btn" @onclick='() => SetPresetSize(1024, 768)'>1024×768</button>
                            <button class="preset-btn" @onclick='() => SetPresetSize(1280, 720)'>HD 720p</button>
                            <button class="preset-btn" @onclick='() => SetPresetSize(1920, 1080)'>Full HD</button>
                            <button class="preset-btn" @onclick='() => SetPresetSize(375, 667)'>iPhone SE</button>
                            <button class="preset-btn" @onclick='() => SetPresetSize(390, 844)'>iPhone 14</button>
                        </div>
                    </div>
                    
                    <div class="dialog-field">
                        <label class="dialog-label">Background Color</label>
                        <div class="color-picker-row">
                            <input type="color" 
                                   class="color-picker"
                                   @bind="BackgroundColor"
                                   @bind:event="oninput" />
                            <input type="text" 
                                   class="dialog-input color-text"
                                   @bind="BackgroundColor"
                                   @bind:event="oninput" />
                        </div>
                    </div>
                </div>

                <div class="dialog-section">
                    <h4 class="dialog-section-title">AI Context</h4>
                    <p class="dialog-hint">This information helps AI assistants understand and resume your design task.</p>
                    
                    <div class="dialog-field">
                        <label class="dialog-label">Original AI Prompt</label>
                        <textarea class="dialog-input dialog-textarea ai-context-field" 
                                  placeholder="The original prompt from the AI assistant (if any)"
                                  rows="2"
                                  @bind="Prompt"
                                  @bind:event="oninput"></textarea>
                    </div>
                    
                    <div class="dialog-field">
                        <label class="dialog-label">AI Context / Notes</label>
                        <textarea class="dialog-input dialog-textarea ai-context-field" 
                                  placeholder="Additional context for AI assistants (task details, constraints, requirements...)"
                                  rows="3"
                                  @bind="AiContext"
                                  @bind:event="oninput"></textarea>
                    </div>
                </div>

                <div class="dialog-section">
                    <h4 class="dialog-section-title">Timestamps</h4>
                    <div class="dialog-row">
                        <div class="dialog-field dialog-field-half">
                            <label class="dialog-label">Created</label>
                            <span class="dialog-value">@Document.CreatedAt.ToString("g")</span>
                        </div>
                        <div class="dialog-field dialog-field-half">
                            <label class="dialog-label">Modified</label>
                            <span class="dialog-value">@Document.ModifiedAt.ToString("g")</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="dialog-footer">
                <button class="dialog-btn dialog-btn-secondary" @onclick="Close">Cancel</button>
                <button class="dialog-btn dialog-btn-primary" @onclick="Apply">Apply</button>
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public bool IsVisible { get; set; }
    
    [Parameter]
    public EventCallback<bool> IsVisibleChanged { get; set; }
    
    private DesignDocument Document => DesignService.Document;
    
    // Local copies for editing
    private string DocumentTitle { get; set; } = "";
    private string? DocumentDescription { get; set; }
    private double CanvasWidth { get; set; }
    private double CanvasHeight { get; set; }
    private string BackgroundColor { get; set; } = "#1e1e1e";
    private string? Prompt { get; set; }
    private string? AiContext { get; set; }
    
    protected override void OnParametersSet()
    {
        if (IsVisible)
        {
            // Load current values when dialog opens
            DocumentTitle = Document.Title;
            DocumentDescription = Document.Description;
            CanvasWidth = Document.CanvasWidth;
            CanvasHeight = Document.CanvasHeight;
            BackgroundColor = Document.BackgroundColor;
            Prompt = Document.Prompt;
            AiContext = Document.AiContext;
        }
    }
    
    private void SetPresetSize(double width, double height)
    {
        CanvasWidth = width;
        CanvasHeight = height;
    }
    
    private async Task Apply()
    {
        // Apply changes to the document
        Document.Title = DocumentTitle;
        Document.Description = DocumentDescription;
        Document.CanvasWidth = CanvasWidth;
        Document.CanvasHeight = CanvasHeight;
        Document.BackgroundColor = BackgroundColor;
        Document.Prompt = Prompt;
        Document.AiContext = AiContext;
        
        DesignService.NotifyStateChanged();
        await Close();
    }
    
    private async Task Close()
    {
        IsVisible = false;
        await IsVisibleChanged.InvokeAsync(false);
    }
}
