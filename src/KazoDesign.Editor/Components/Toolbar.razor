@using KazoDesign.Editor.Models
@using KazoDesign.Editor.Services
@inject DesignService DesignService
@inject IJSRuntime JS
@implements IDisposable

<div class="toolbar">
    <div class="toolbar-group confirm-group">
        <button class="toolbar-btn confirm-btn" @onclick="ConfirmAndReturn" title="Confirm & Return to AI">
            <svg viewBox="0 0 24 24" width="20" height="20">
                <path d="M20 6L9 17l-5-5" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <span class="btn-text">Confirm & Return to AI</span>
        </button>
    </div>

    <div class="toolbar-group">
        <span class="toolbar-title">Canvas</span>
        <button class="toolbar-btn" @onclick="OpenCanvasProperties" title="Canvas Properties">
            <svg viewBox="0 0 24 24" width="20" height="20">
                <circle cx="12" cy="12" r="3" fill="none" stroke="currentColor" stroke-width="2"/>
                <path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z" fill="none" stroke="currentColor" stroke-width="2"/>
            </svg>
        </button>
        <span class="canvas-info" title="Canvas size">@($"{DesignService.Document.CanvasWidth}Ã—{DesignService.Document.CanvasHeight}")</span>
    </div>

    <div class="toolbar-group">
        <span class="toolbar-title">Tools</span>
        <button class="toolbar-btn @(DesignService.CurrentTool == DrawingTool.Select ? "active" : "")" 
                @onclick="SelectTool" title="Select (V)">
            <svg viewBox="0 0 24 24" width="20" height="20">
                <path d="M3 3l7.07 16.97 2.51-7.39 7.39-2.51L3 3z" fill="none" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
            </svg>
        </button>
        <button class="toolbar-btn @(DesignService.CurrentTool == DrawingTool.Rectangle ? "active" : "")" 
                @onclick="SelectRectangleTool" title="Rectangle (R)">
            <svg viewBox="0 0 24 24" width="20" height="20">
                <rect x="3" y="3" width="18" height="18" rx="2" fill="none" stroke="currentColor" stroke-width="2"/>
            </svg>
        </button>
        <button class="toolbar-btn @(DesignService.CurrentTool == DrawingTool.Circle ? "active" : "")" 
                @onclick="SelectCircleTool" title="Circle (C)">
            <svg viewBox="0 0 24 24" width="20" height="20">
                <circle cx="12" cy="12" r="9" fill="none" stroke="currentColor" stroke-width="2"/>
            </svg>
        </button>
        <button class="toolbar-btn @(DesignService.CurrentTool == DrawingTool.Line ? "active" : "")" 
                @onclick="SelectLineTool" title="Line (L)">
            <svg viewBox="0 0 24 24" width="20" height="20">
                <line x1="4" y1="20" x2="20" y2="4" stroke="currentColor" stroke-width="2"/>
            </svg>
        </button>
        <button class="toolbar-btn @(DesignService.CurrentTool == DrawingTool.Text ? "active" : "")" 
                @onclick="SelectTextTool" title="Text (T)">
            <svg viewBox="0 0 24 24" width="20" height="20">
                <text x="6" y="18" font-size="16" fill="currentColor">T</text>
            </svg>
        </button>
    </div>
    
    <div class="toolbar-group">
        <span class="toolbar-title">Actions</span>
        <button class="toolbar-btn" @onclick="LoadSampleShapes" title="Load Samples">
            <svg viewBox="0 0 24 24" width="20" height="20">
                <path d="M12 2L2 7l10 5 10-5-10-5z" fill="none" stroke="currentColor" stroke-width="2"/>
                <path d="M2 17l10 5 10-5" fill="none" stroke="currentColor" stroke-width="2"/>
                <path d="M2 12l10 5 10-5" fill="none" stroke="currentColor" stroke-width="2"/>
            </svg>
        </button>
        <button class="toolbar-btn" @onclick="ClearCanvas" title="Clear Canvas">
            <svg viewBox="0 0 24 24" width="20" height="20">
                <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6M8 6V4a2 2 0 012-2h4a2 2 0 012 2v2" fill="none" stroke="currentColor" stroke-width="2"/>
            </svg>
        </button>
        <button class="toolbar-btn primary" @onclick="ExportSvg" title="Export SVG">
            <svg viewBox="0 0 24 24" width="20" height="20">
                <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3" fill="none" stroke="currentColor" stroke-width="2"/>
            </svg>
        </button>
        <button class="toolbar-btn" @onclick="ExportJson" title="Export JSON">
            <svg viewBox="0 0 24 24" width="20" height="20">
                <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z" fill="none" stroke="currentColor" stroke-width="2"/>
                <path d="M14 2v6h6M16 13H8M16 17H8M10 9H8" fill="none" stroke="currentColor" stroke-width="2"/>
            </svg>
        </button>
    </div>
    
    @if (DesignService.SelectedElement != null)
    {
        <div class="toolbar-group">
            <span class="toolbar-title">Selection</span>
            <button class="toolbar-btn" @onclick="OpenPropertiesDialog" title="Edit Properties">
                <svg viewBox="0 0 24 24" width="20" height="20">
                    <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7" fill="none" stroke="currentColor" stroke-width="2"/>
                    <path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z" fill="none" stroke="currentColor" stroke-width="2"/>
                </svg>
            </button>
            <button class="toolbar-btn danger" @onclick="DeleteSelected" title="Delete Selected">
                <svg viewBox="0 0 24 24" width="20" height="20">
                    <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2"/>
                </svg>
            </button>
            <span class="selection-info">@DesignService.SelectedElement.ElementType</span>
        </div>
    }
</div>

<PropertiesDialog @bind-IsVisible="_showPropertiesDialog" Element="@DesignService.SelectedElement" />
<CanvasPropertiesDialog @bind-IsVisible="_showCanvasPropertiesDialog" />

@code {
    private bool _showPropertiesDialog;
    private bool _showCanvasPropertiesDialog;
    
    protected override void OnInitialized()
    {
        DesignService.OnChange += OnDesignServiceChange;
    }
    
    public void Dispose()
    {
        DesignService.OnChange -= OnDesignServiceChange;
    }
    
    private void OnDesignServiceChange()
    {
        // Check if this is a double-click event (element selected with showProperties flag)
        if (DesignService.ShouldShowPropertiesDialog)
        {
            _showPropertiesDialog = true;
            DesignService.ShouldShowPropertiesDialog = false;
        }
        StateHasChanged();
    }
    
    private void OpenPropertiesDialog()
    {
        _showPropertiesDialog = true;
    }
    
    private void OpenCanvasProperties()
    {
        _showCanvasPropertiesDialog = true;
    }
    
    private async Task ConfirmAndReturn()
    {
        var result = DesignService.ExportDesignSync();
        await JS.InvokeVoidAsync("kazoDesign.confirmAndReturn", result.Svg, result.Json, result.Title);
    }
    
    private void SelectTool()
    {
        DesignService.CurrentTool = DrawingTool.Select;
        DesignService.NotifyStateChanged();
    }
    
    private void SelectRectangleTool()
    {
        DesignService.CurrentTool = DrawingTool.Rectangle;
        DesignService.NotifyStateChanged();
    }
    
    private void SelectCircleTool()
    {
        DesignService.CurrentTool = DrawingTool.Circle;
        DesignService.NotifyStateChanged();
    }
    
    private void SelectLineTool()
    {
        DesignService.CurrentTool = DrawingTool.Line;
        DesignService.NotifyStateChanged();
    }
    
    private void SelectTextTool()
    {
        DesignService.CurrentTool = DrawingTool.Text;
        DesignService.NotifyStateChanged();
    }
    
    private void AddRectangle()
    {
        var rect = new KRectangle
        {
            X = 100 + Random.Shared.Next(100),
            Y = 100 + Random.Shared.Next(100),
            Width = 100,
            Height = 60,
            Description = "New rectangle"
        };
        DesignService.AddElement(rect);
    }
    
    private void AddCircle()
    {
        var circle = new KCircle
        {
            X = 200 + Random.Shared.Next(100),
            Y = 150 + Random.Shared.Next(100),
            Radius = 40,
            Description = "New circle"
        };
        DesignService.AddElement(circle);
    }
    
    private void AddLine()
    {
        var startX = 100 + Random.Shared.Next(100);
        var startY = 100 + Random.Shared.Next(100);
        var line = new KLine
        {
            X = startX,
            Y = startY,
            X2 = startX + 100,
            Y2 = startY + 80,
            Description = "New line"
        };
        DesignService.AddElement(line);
    }
    
    private void AddText()
    {
        var text = new KText
        {
            X = 100 + Random.Shared.Next(100),
            Y = 100 + Random.Shared.Next(100),
            Content = "New Text",
            FontSize = 18,
            Description = "New text element"
        };
        DesignService.AddElement(text);
    }
    
    private void LoadSampleShapes()
    {
        DesignService.AddSampleShapes();
    }
    
    private void ClearCanvas()
    {
        DesignService.ClearCanvas();
    }
    
    private void DeleteSelected()
    {
        if (DesignService.SelectedElement != null)
        {
            DesignService.RemoveElement(DesignService.SelectedElement);
        }
    }
    
    private async Task ExportSvg()
    {
        var result = DesignService.ExportDesignSync();
        await JS.InvokeVoidAsync("kazoDesign.downloadSvg", result.Svg, $"{DesignService.Document.Title}.svg");
    }
    
    private async Task ExportJson()
    {
        var result = DesignService.ExportDesignSync();
        await JS.InvokeVoidAsync("kazoDesign.downloadJson", result.Json, $"{DesignService.Document.Title}.json");
    }
}
