@using KazoDesign.Editor.Models

@{
    var bounds = GetElementBounds();
}

<!-- Selection rectangle -->
<rect x="@((bounds.x - 4).ToString(System.Globalization.CultureInfo.InvariantCulture))" 
      y="@((bounds.y - 4).ToString(System.Globalization.CultureInfo.InvariantCulture))"
      width="@((bounds.width + 8).ToString(System.Globalization.CultureInfo.InvariantCulture))" 
      height="@((bounds.height + 8).ToString(System.Globalization.CultureInfo.InvariantCulture))"
      fill="none"
      stroke="#00d4ff"
      stroke-width="1"
      stroke-dasharray="4,2"
      pointer-events="none" />

<!-- Corner handles - Top Left -->
<circle cx="@((bounds.x - 4).ToString(System.Globalization.CultureInfo.InvariantCulture))" 
        cy="@((bounds.y - 4).ToString(System.Globalization.CultureInfo.InvariantCulture))" 
        r="5" 
        fill="#00d4ff" 
        class="handle handle-nw"
        @onmousedown="@(e => OnHandleMouseDown(e, ResizeHandle.TopLeft))"
        @onmousedown:stopPropagation="true" />

<!-- Corner handles - Top Right -->
<circle cx="@((bounds.x + bounds.width + 4).ToString(System.Globalization.CultureInfo.InvariantCulture))" 
        cy="@((bounds.y - 4).ToString(System.Globalization.CultureInfo.InvariantCulture))" 
        r="5" 
        fill="#00d4ff" 
        class="handle handle-ne"
        @onmousedown="@(e => OnHandleMouseDown(e, ResizeHandle.TopRight))"
        @onmousedown:stopPropagation="true" />

<!-- Corner handles - Bottom Left -->
<circle cx="@((bounds.x - 4).ToString(System.Globalization.CultureInfo.InvariantCulture))" 
        cy="@((bounds.y + bounds.height + 4).ToString(System.Globalization.CultureInfo.InvariantCulture))" 
        r="5" 
        fill="#00d4ff" 
        class="handle handle-sw"
        @onmousedown="@(e => OnHandleMouseDown(e, ResizeHandle.BottomLeft))"
        @onmousedown:stopPropagation="true" />

<!-- Corner handles - Bottom Right -->
<circle cx="@((bounds.x + bounds.width + 4).ToString(System.Globalization.CultureInfo.InvariantCulture))" 
        cy="@((bounds.y + bounds.height + 4).ToString(System.Globalization.CultureInfo.InvariantCulture))" 
        r="5" 
        fill="#00d4ff" 
        class="handle handle-se"
        @onmousedown="@(e => OnHandleMouseDown(e, ResizeHandle.BottomRight))"
        @onmousedown:stopPropagation="true" />

@code {
    [Parameter, EditorRequired]
    public DesignElement Element { get; set; } = default!;
    
    [Parameter]
    public EventCallback<(ResizeHandle Handle, MouseEventArgs Args)> OnResizeStart { get; set; }
    
    public enum ResizeHandle
    {
        TopLeft,
        TopRight,
        BottomLeft,
        BottomRight
    }
    
    private async Task OnHandleMouseDown(MouseEventArgs e, ResizeHandle handle)
    {
        await OnResizeStart.InvokeAsync((handle, e));
    }
    
    private (double x, double y, double width, double height) GetElementBounds()
    {
        return Element switch
        {
            KRectangle rect => (rect.X, rect.Y, rect.Width, rect.Height),
            KCircle circle => (circle.X - circle.Radius, circle.Y - circle.Radius, circle.Radius * 2, circle.Radius * 2),
            KLine line => (Math.Min(line.X, line.X2), Math.Min(line.Y, line.Y2), 
                          Math.Abs(line.X2 - line.X), Math.Abs(line.Y2 - line.Y)),
            KText text => (text.X, text.Y - text.FontSize, text.Content.Length * text.FontSize * 0.6, text.FontSize * 1.2),
            KImage image => (image.X, image.Y, image.Width, image.Height),
            _ => (Element.X, Element.Y, 50, 50)
        };
    }
}
