@using KazoDesign.Editor.Models
@using KazoDesign.Editor.Services
@inject DesignService DesignService

@if (IsVisible && Element != null)
{
    <div class="dialog-overlay" @onclick="Close">
        <div class="dialog dialog-large" @onclick:stopPropagation="true">
            <div class="dialog-header">
                <h3>Edit Properties</h3>
                <button class="dialog-close-btn" @onclick="Close" title="Close">
                    <svg viewBox="0 0 24 24" width="16" height="16">
                        <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2"/>
                    </svg>
                </button>
            </div>
            
            <div class="dialog-body">
                <div class="dialog-section">
                    <h4 class="dialog-section-title">General</h4>
                    
                    <div class="dialog-field">
                        <label class="dialog-label">Element Type</label>
                        <span class="dialog-value">@Element.ElementType</span>
                    </div>
                    
                    <div class="dialog-field">
                        <label class="dialog-label">Name</label>
                        <input type="text" 
                               class="dialog-input" 
                               placeholder="Enter element name"
                               @bind="ElementName"
                               @bind:event="oninput" />
                    </div>
                    
                    <div class="dialog-field">
                        <label class="dialog-label">Description</label>
                        <textarea class="dialog-input dialog-textarea" 
                                  placeholder="Enter element description"
                                  @bind="ElementDescription"
                                  @bind:event="oninput"></textarea>
                    </div>
                </div>

                <div class="dialog-section">
                    <h4 class="dialog-section-title">Position & Size</h4>
                    
                    @if (Element is KLine)
                    {
                        <div class="dialog-row">
                            <div class="dialog-field dialog-field-quarter">
                                <label class="dialog-label">Start X</label>
                                <input type="number" step="0.1"
                                       class="dialog-input" 
                                       @bind="ElementX"
                                       @bind:event="oninput" />
                            </div>
                            <div class="dialog-field dialog-field-quarter">
                                <label class="dialog-label">Start Y</label>
                                <input type="number" step="0.1"
                                       class="dialog-input" 
                                       @bind="ElementY"
                                       @bind:event="oninput" />
                            </div>
                            <div class="dialog-field dialog-field-quarter">
                                <label class="dialog-label">End X</label>
                                <input type="number" step="0.1"
                                       class="dialog-input" 
                                       @bind="LineX2"
                                       @bind:event="oninput" />
                            </div>
                            <div class="dialog-field dialog-field-quarter">
                                <label class="dialog-label">End Y</label>
                                <input type="number" step="0.1"
                                       class="dialog-input" 
                                       @bind="LineY2"
                                       @bind:event="oninput" />
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="dialog-row">
                            <div class="dialog-field dialog-field-half">
                                <label class="dialog-label">X</label>
                                <input type="number" step="0.1"
                                       class="dialog-input" 
                                       @bind="ElementX"
                                       @bind:event="oninput" />
                            </div>
                            <div class="dialog-field dialog-field-half">
                                <label class="dialog-label">Y</label>
                                <input type="number" step="0.1"
                                       class="dialog-input" 
                                       @bind="ElementY"
                                       @bind:event="oninput" />
                            </div>
                        </div>
                        
                        @if (Element is KRectangle || Element is KImage)
                        {
                            <div class="dialog-row">
                                <div class="dialog-field dialog-field-half">
                                    <label class="dialog-label">Width</label>
                                    <input type="number" step="0.1" min="1"
                                           class="dialog-input" 
                                           @bind="ElementWidth"
                                           @bind:event="oninput" />
                                </div>
                                <div class="dialog-field dialog-field-half">
                                    <label class="dialog-label">Height</label>
                                    <input type="number" step="0.1" min="1"
                                           class="dialog-input" 
                                           @bind="ElementHeight"
                                           @bind:event="oninput" />
                                </div>
                            </div>
                        }
                        
                        @if (Element is KCircle)
                        {
                            <div class="dialog-field">
                                <label class="dialog-label">Radius</label>
                                <input type="number" step="0.1" min="1"
                                       class="dialog-input" 
                                       @bind="CircleRadius"
                                       @bind:event="oninput" />
                            </div>
                        }
                    }
                </div>

                <div class="dialog-section">
                    <h4 class="dialog-section-title">Appearance</h4>
                    
                    @if (Element is KRectangle || Element is KCircle)
                    {
                        <div class="dialog-row">
                            <div class="dialog-field dialog-field-half">
                                <label class="dialog-label">Fill Color</label>
                                <div class="color-input-wrapper">
                                    <input type="color" 
                                           class="dialog-color-input" 
                                           @bind="ElementFillColor" />
                                    <input type="text" 
                                           class="dialog-input dialog-input-color-text" 
                                           placeholder="#4a90d9"
                                           @bind="ElementFillColor"
                                           @bind:event="oninput" />
                                </div>
                            </div>
                            
                            <div class="dialog-field dialog-field-half">
                                <label class="dialog-label">Stroke Color</label>
                                <div class="color-input-wrapper">
                                    <input type="color" 
                                           class="dialog-color-input" 
                                           @bind="ElementStrokeColor" />
                                    <input type="text" 
                                           class="dialog-input dialog-input-color-text" 
                                           placeholder="#2d5a87"
                                           @bind="ElementStrokeColor"
                                           @bind:event="oninput" />
                                </div>
                            </div>
                        </div>
                        
                        <div class="dialog-row">
                            <div class="dialog-field dialog-field-half">
                                <label class="dialog-label">Stroke Width</label>
                                <input type="number" step="0.5" min="0"
                                       class="dialog-input" 
                                       @bind="ElementStrokeWidth"
                                       @bind:event="oninput" />
                            </div>
                            @if (Element is KRectangle)
                            {
                                <div class="dialog-field dialog-field-half">
                                    <label class="dialog-label">Corner Radius</label>
                                    <input type="number" step="1" min="0"
                                           class="dialog-input" 
                                           @bind="ElementCornerRadius"
                                           @bind:event="oninput" />
                                </div>
                            }
                        </div>
                    }
                    else if (Element is KLine)
                    {
                        <div class="dialog-row">
                            <div class="dialog-field dialog-field-half">
                                <label class="dialog-label">Stroke Color</label>
                                <div class="color-input-wrapper">
                                    <input type="color" 
                                           class="dialog-color-input" 
                                           @bind="ElementStrokeColor" />
                                    <input type="text" 
                                           class="dialog-input dialog-input-color-text" 
                                           placeholder="#f0ad4e"
                                           @bind="ElementStrokeColor"
                                           @bind:event="oninput" />
                                </div>
                            </div>
                            
                            <div class="dialog-field dialog-field-half">
                                <label class="dialog-label">Stroke Width</label>
                                <input type="number" step="0.5" min="0.5"
                                       class="dialog-input" 
                                       @bind="ElementStrokeWidth"
                                       @bind:event="oninput" />
                            </div>
                        </div>
                    }
                </div>

                <div class="dialog-section">
                    <h4 class="dialog-section-title">Semantic</h4>
                    
                    <div class="dialog-field">
                        <label class="dialog-label">Meaning (Optional)</label>
                        <select class="dialog-select" @bind="ElementMeaning">
                            <option value="">None</option>
                            <option value="Control">Control</option>
                            <optgroup label="Layout Sections">
                                <option value="NavBar">NavBar</option>
                                <option value="Toolbar">Toolbar</option>
                                <option value="Body">Body</option>
                                <option value="Panel">Panel</option>
                                <option value="Footer">Footer</option>
                                <option value="View">View</option>
                            </optgroup>
                            <option value="ImagePlaceholder">Image Placeholder</option>
                        </select>
                    </div>
                </div>

                @if (Element is KText textElement)
                {
                    <div class="dialog-section">
                        <h4 class="dialog-section-title">Text Properties</h4>
                        
                        <div class="dialog-field">
                            <label class="dialog-label">Text Type</label>
                            <select class="dialog-select" @bind="SelectedTextType">
                                <option value="Paragraph">Paragraph</option>
                                <optgroup label="Headers">
                                    <option value="H1">H1 - Main Header (32px)</option>
                                    <option value="H2">H2 - Section Header (28px)</option>
                                    <option value="H3">H3 - Sub Header (24px)</option>
                                    <option value="H4">H4 - Minor Header (20px)</option>
                                    <option value="H5">H5 - Small Header (18px)</option>
                                </optgroup>
                                <option value="Link">Link</option>
                            </select>
                        </div>

                        @if (SelectedTextType == "Link")
                        {
                            <div class="dialog-field">
                                <label class="dialog-label">Link URL</label>
                                <input type="url" 
                                       class="dialog-input" 
                                       placeholder="https://example.com"
                                       @bind="TextLinkUrl"
                                       @bind:event="oninput" />
                            </div>
                        }

                        <div class="dialog-field">
                            <label class="dialog-label">Content</label>
                            <input type="text" 
                                   class="dialog-input" 
                                   placeholder="Text content"
                                   @bind="TextContent"
                                   @bind:event="oninput" />
                        </div>
                        
                        <div class="dialog-field">
                            <label class="dialog-label">Text Color</label>
                            <div class="color-input-wrapper">
                                <input type="color" 
                                       class="dialog-color-input" 
                                       @bind="TextFillColor" />
                                <input type="text" 
                                       class="dialog-input dialog-input-color-text" 
                                       placeholder="#e0e0e0"
                                       @bind="TextFillColor"
                                       @bind:event="oninput" />
                            </div>
                        </div>
                    </div>
                }
            </div>
            
            <div class="dialog-footer">
                <button class="dialog-btn dialog-btn-secondary" @onclick="Close">Cancel</button>
                <button class="dialog-btn dialog-btn-primary" @onclick="Save">Save</button>
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public bool IsVisible { get; set; }
    
    [Parameter]
    public EventCallback<bool> IsVisibleChanged { get; set; }
    
    [Parameter]
    public DesignElement? Element { get; set; }
    
    private string? ElementName { get; set; }
    private string? ElementDescription { get; set; }
    private string ElementMeaning { get; set; } = "";
    
    // Position & Size properties
    private double ElementX { get; set; }
    private double ElementY { get; set; }
    private double ElementWidth { get; set; }
    private double ElementHeight { get; set; }
    private double CircleRadius { get; set; }
    private double LineX2 { get; set; }
    private double LineY2 { get; set; }
    
    // Text-specific properties
    private string SelectedTextType { get; set; } = "Paragraph";
    private string? TextLinkUrl { get; set; }
    private string? TextContent { get; set; }
    private string TextFillColor { get; set; } = "#e0e0e0";
    
    // Color properties for shapes with fill/stroke
    private string ElementFillColor { get; set; } = "#4a90d9";
    private string ElementStrokeColor { get; set; } = "#2d5a87";
    private double ElementStrokeWidth { get; set; } = 2;
    private double ElementCornerRadius { get; set; } = 0;
    
    protected override void OnParametersSet()
    {
        if (Element != null && IsVisible)
        {
            ElementName = Element.Name;
            ElementDescription = Element.Description;
            ElementMeaning = Element.Meaning?.ToString() ?? "";
            
            // Position
            ElementX = Element.X;
            ElementY = Element.Y;
            
            // Size and colors based on element type
            switch (Element)
            {
                case KRectangle rect:
                    ElementWidth = rect.Width;
                    ElementHeight = rect.Height;
                    ElementFillColor = rect.Fill;
                    ElementStrokeColor = rect.Stroke;
                    ElementStrokeWidth = rect.StrokeWidth;
                    ElementCornerRadius = rect.CornerRadius;
                    break;
                case KCircle circle:
                    CircleRadius = circle.Radius;
                    ElementFillColor = circle.Fill;
                    ElementStrokeColor = circle.Stroke;
                    ElementStrokeWidth = circle.StrokeWidth;
                    break;
                case KImage image:
                    ElementWidth = image.Width;
                    ElementHeight = image.Height;
                    break;
                case KLine line:
                    LineX2 = line.X2;
                    LineY2 = line.Y2;
                    ElementStrokeColor = line.Stroke;
                    ElementStrokeWidth = line.StrokeWidth;
                    break;
                case KText textElement:
                    SelectedTextType = textElement.TextType.ToString();
                    TextLinkUrl = textElement.LinkUrl;
                    TextContent = textElement.Content;
                    TextFillColor = textElement.Fill;
                    break;
            }
        }
    }
    
    private async Task Close()
    {
        await IsVisibleChanged.InvokeAsync(false);
    }
    
    private async Task Save()
    {
        if (Element != null)
        {
            Element.Name = ElementName;
            Element.Description = ElementDescription;
            
            // Position
            Element.X = ElementX;
            Element.Y = ElementY;
            
            if (!string.IsNullOrEmpty(ElementMeaning) && Enum.TryParse<ElementMeaning>(ElementMeaning, out var meaning))
            {
                Element.Meaning = meaning;
            }
            else
            {
                Element.Meaning = null;
            }
            
            // Size and colors based on element type
            switch (Element)
            {
                case KRectangle rect:
                    rect.Width = Math.Max(1, ElementWidth);
                    rect.Height = Math.Max(1, ElementHeight);
                    rect.Fill = ElementFillColor;
                    rect.Stroke = ElementStrokeColor;
                    rect.StrokeWidth = ElementStrokeWidth;
                    rect.CornerRadius = ElementCornerRadius;
                    break;
                case KCircle circle:
                    circle.Radius = Math.Max(1, CircleRadius);
                    circle.Fill = ElementFillColor;
                    circle.Stroke = ElementStrokeColor;
                    circle.StrokeWidth = ElementStrokeWidth;
                    break;
                case KImage image:
                    image.Width = Math.Max(1, ElementWidth);
                    image.Height = Math.Max(1, ElementHeight);
                    break;
                case KLine line:
                    line.X2 = LineX2;
                    line.Y2 = LineY2;
                    line.Stroke = ElementStrokeColor;
                    line.StrokeWidth = ElementStrokeWidth;
                    break;
                case KText textElement:
                    if (Enum.TryParse<TextType>(SelectedTextType, out var textType))
                    {
                        textElement.TextType = textType;
                    }
                    textElement.LinkUrl = TextLinkUrl;
                    textElement.Content = TextContent ?? "Text";
                    textElement.Fill = TextFillColor;
                    break;
            }
            
            DesignService.NotifyStateChanged();
        }
        await Close();
    }
}
