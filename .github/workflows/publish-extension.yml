name: Publish VS Code Extension

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Release type (pre-release or release)'
        required: true
        default: 'release'
        type: choice
        options:
          - release
          - pre-release

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET 10
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: vscode-extension/package-lock.json

      - name: Build Blazor UI
        run: |
          cd src/KazoDesign.Editor
          dotnet restore
          dotnet publish -c Release -o ../../vscode-extension/media/ui

      - name: Install VS Code Extension dependencies
        run: |
          cd vscode-extension
          npm ci

      - name: Compile TypeScript
        run: |
          cd vscode-extension
          npm run compile

      - name: Install vsce
        run: npm install -g @vscode/vsce

      - name: Package extension
        run: |
          cd vscode-extension
          vsce package

      - name: Upload VSIX artifact
        uses: actions/upload-artifact@v4
        with:
          name: kazo-design-mcp-vsix
          path: vscode-extension/*.vsix
          retention-days: 30

  publish:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'release' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET 10
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: vscode-extension/package-lock.json

      - name: Build Blazor UI
        run: |
          cd src/KazoDesign.Editor
          dotnet restore
          dotnet publish -c Release -o ../../vscode-extension/media/ui

      - name: Install VS Code Extension dependencies
        run: |
          cd vscode-extension
          npm ci

      - name: Compile TypeScript
        run: |
          cd vscode-extension
          npm run compile

      - name: Install vsce
        run: npm install -g @vscode/vsce

      - name: Publish to VS Code Marketplace
        env:
          VSCE_PAT: ${{ secrets.VSCE_PAT }}
        run: |
          cd vscode-extension
          if [ "${{ github.event.inputs.release_type }}" = "pre-release" ]; then
            vsce publish --pre-release
          else
            vsce publish
          fi

      - name: Publish to Open VSX Registry
        env:
          OVSX_PAT: ${{ secrets.OVSX_PAT }}
        run: |
          npm install -g ovsx
          cd vscode-extension
          if [ "${{ github.event.inputs.release_type }}" = "pre-release" ]; then
            ovsx publish --pre-release
          else
            ovsx publish
          fi
        continue-on-error: true
